# Power Analysis ç­›é€‰é€»è¾‘ä¼˜åŒ– v2.5.4

## ğŸ“ æ›´æ–°æ—¥æœŸ
2026-01-04

## ğŸ¯ æ›´æ–°å†…å®¹

### 1. åœ°å›¾è‡ªåŠ¨ç¼©æ”¾ (Auto Map Zoom)
- åº”ç”¨ç­›é€‰åè‡ªåŠ¨ç¼©æ”¾åœ°å›¾
- æ‰€æœ‰ç¬¦åˆæ¡ä»¶çš„ç«™ç‚¹éƒ½æ˜¾ç¤ºåœ¨è§†é‡å†…
- æ™ºèƒ½è°ƒæ•´ç¼©æ”¾çº§åˆ«ï¼ˆæœ€å¤§zoom = 15ï¼‰

### 2. åœ°å›¾æ ‡è®°è‡ªåŠ¨ç¼–å· (Marker Numbering)
- å‹¾é€‰ "ğŸ·ï¸ Labels" æ˜¾ç¤ºæ ‡è®°ç¼–å·
- ç¼–å·åŸºäºå½“å‰æ’åºé¡ºåº
- æ›´å¤§çš„æ ‡è®°åœ†åœˆä»¥å®¹çº³æ•°å­—
- ç™½è‰²ç²—ä½“æ•°å­—ï¼Œæ¸…æ™°å¯è§

### 3. ç¼–å·ä¸æ’åºåŒæ­¥ (Synchronized Numbering)
- Site List å’Œ Map ç¼–å·å®Œå…¨åŒæ­¥
- æ”¹å˜æ’åºæ—¶ï¼Œç¼–å·è‡ªåŠ¨æ›´æ–°
- é»˜è®¤æŒ‰ Max Utilisation (ä½åˆ°é«˜) æ’åº
- æ”¯æŒä¸‰ç§æ’åºæ–¹å¼åˆ‡æ¢

## ğŸ“Š ç­›é€‰é€»è¾‘æµç¨‹

### æ­¥éª¤ 1: è®¾ç½®ç­›é€‰æ¡ä»¶
- Max Utilisation: 40% (é»˜è®¤)
- Min ONAN Rating: 1000 kVA (é»˜è®¤)
- Density Radius: 5 km (é»˜è®¤)
- Min Supplies in Radius: 3 (é»˜è®¤)
- Region/Area: é€‰æ‹©åŒºåŸŸ (å¯é€‰)
- Search: æœç´¢ç«™ç‚¹åç§°/åœ°å€ (å¯é€‰)

### æ­¥éª¤ 2: ç‚¹å‡» "Apply Filters to Map"
- ä»åç«¯CSVæ•°æ®è¿‡æ»¤ç«™ç‚¹
- åº”ç”¨æ‰€æœ‰ç­›é€‰æ¡ä»¶

### æ­¥éª¤ 3: åœ°å›¾è‡ªåŠ¨æ›´æ–°
- æ¸…é™¤æ—§æ ‡è®°
- åˆ›å»ºæ–°æ ‡è®°ï¼ˆç¬¦åˆç­›é€‰æ¡ä»¶ï¼‰
- **è‡ªåŠ¨ç¼©æ”¾æ˜¾ç¤ºæ‰€æœ‰ç«™ç‚¹**
- å¦‚æœ Labels å·²å‹¾é€‰ï¼Œæ˜¾ç¤ºç¼–å·

### æ­¥éª¤ 4: æ˜¾ç¤ºç­›é€‰åçš„ç«™ç‚¹åˆ—è¡¨
- åˆ—è¡¨æ˜¾ç¤ºåœ¨åœ°å›¾ä¸‹æ–¹
- é»˜è®¤æŒ‰ Max Utilisation æ’åº
- ç¼–å·ä» 1 å¼€å§‹

### æ­¥éª¤ 5: æ”¹å˜æ’åº (å¯é€‰)
- é€‰æ‹©æ’åºæ–¹å¼:
  - Max Utilisation (Low to High) - é»˜è®¤
  - Min ONAN Rating (Low to High)
  - Supplies in Radius (High to Low)
- åˆ—è¡¨ç«‹å³é‡æ–°æ’åº
- **å¦‚æœ Labels å·²å‹¾é€‰ï¼Œåœ°å›¾æ ‡è®°ä¹Ÿé‡æ–°ç¼–å·**

## ğŸ·ï¸ Labels åŠŸèƒ½è¯¦è§£

### å¯ç”¨ Labels
1. åº”ç”¨ç­›é€‰åï¼Œåœ°å›¾æ˜¾ç¤ºç¬¦åˆæ¡ä»¶çš„ç«™ç‚¹
2. å‹¾é€‰åœ°å›¾æ§åˆ¶åŒºçš„ "ğŸ·ï¸ Labels" å¤é€‰æ¡†
3. åœ°å›¾æ ‡è®°è‡ªåŠ¨æ·»åŠ ç¼–å·
4. æ ‡è®°å˜å¤§ä»¥å®¹çº³æ•°å­—

### ç¼–å·è§„åˆ™
- **ç¼–å·ä» 1 å¼€å§‹**
- **åŸºäºå½“å‰æ’åºé¡ºåº**

**é»˜è®¤æ’åº: Max Utilisation (ä½åˆ°é«˜)**
- #1 = åˆ©ç”¨ç‡æœ€ä½çš„ç«™ç‚¹
- #2 = åˆ©ç”¨ç‡ç¬¬äºŒä½çš„ç«™ç‚¹
- ...

**ONAN æ’åº:**
- #1 = ONANå®¹é‡æœ€å°çš„ç«™ç‚¹
- ...

**Supplies æ’åº:**
- #1 = å‘¨è¾¹ç«™ç‚¹æ•°æœ€å¤šçš„ç«™ç‚¹
- ...

### åŠ¨æ€æ›´æ–°
- æ”¹å˜æ’åºæ–¹å¼æ—¶ï¼Œç¼–å·è‡ªåŠ¨æ›´æ–°
- Site List å’Œ Map ç¼–å·å§‹ç»ˆåŒæ­¥
- æ ‡è®°é¢œè‰²ä¿æŒä¸å˜ï¼ˆç»¿è‰²/çº¢è‰²åŸºäºåˆ©ç”¨ç‡ï¼‰

## ğŸ¨ è§†è§‰æ•ˆæœ

### æ ‡è®°æ ·å¼

**æ— ç¼–å·æ—¶:**
- å°åœ†ç‚¹ (scale: 5)
- ç»¿è‰²: åˆ©ç”¨ç‡ â‰¤40%
- çº¢è‰²: åˆ©ç”¨ç‡ >40%
- ç™½è‰²è¾¹æ¡†

**æœ‰ç¼–å·æ—¶:**
- å¤§åœ†ç‚¹ (scale: 8)
- ç™½è‰²ç²—ä½“æ•°å­—
- å­—ä½“å¤§å°: 12px
- é«˜ç¼–å·æ ‡è®°æ˜¾ç¤ºåœ¨ä¸Šå±‚

### åœ°å›¾ç¼©æ”¾
- è‡ªåŠ¨åŒ…å«æ‰€æœ‰ç­›é€‰ç»“æœ
- æœ€å¤§ç¼©æ”¾çº§åˆ«: 15 (é˜²æ­¢è¿‡åº¦æ”¾å¤§)
- æ™ºèƒ½è¾¹ç•Œè°ƒæ•´

## ğŸ”§ æŠ€æœ¯å®ç°

### æ–°å¢å˜é‡
```javascript
let showMarkerLabels = false;
let currentSortBy = 'utilisation_asc'; // Track current sort order
```

### æ–°å¢å‡½æ•°
```javascript
// Helper function to sort sites based on current criteria
function getSortedSites(sites) {
  if (!sites || sites.length === 0) return [];
  
  const sitesWithData = sites.map(site => ({
    ...site,
    nearbySupplies: calculateNearbySupplies(site)
  }));
  
  switch(currentSortBy) {
    case 'utilisation_asc':
      return sitesWithData.sort((a, b) => (a.utilisation || 0) - (b.utilisation || 0));
    case 'onan_asc':
      return sitesWithData.sort((a, b) => (a.onanRating || 0) - (b.onanRating || 0));
    case 'supplies_desc':
      return sitesWithData.sort((a, b) => (b.nearbySupplies || 0) - (a.nearbySupplies || 0));
    default:
      return sitesWithData;
  }
}
```

### ä¿®æ”¹å‡½æ•°

**toggleLabels():**
```javascript
window.toggleLabels = function() {
  const checkbox = document.getElementById('show-labels');
  if (!checkbox) return;
  
  showMarkerLabels = checkbox.checked;
  console.log('ğŸ·ï¸ Marker labels:', showMarkerLabels ? 'ON' : 'OFF');
  
  // Reload map to update marker labels
  loadSitesOnMap();
};
```

**loadSitesOnMap():**
- åœ¨åˆ›å»ºæ ‡è®°å‰å…ˆæ’åº: `const sortedSites = getSortedSites(sitesToShow);`
- åˆ›å»ºæ ‡è®°æ—¶æ·»åŠ ç¼–å·å’Œlabelå±æ€§

**sortFilteredSites():**
- æ›´æ–° `currentSortBy` å˜é‡
- å¦‚æœ Labels å·²å¯ç”¨ï¼Œé‡æ–°åŠ è½½åœ°å›¾æ ‡è®°

### æ ‡è®°å±æ€§
```javascript
const marker = new google.maps.Marker({
  position: { lat: site.latitude, lng: site.longitude },
  map: map,
  title: site.siteName || site.address,
  label: showMarkerLabels ? {
    text: String(markerNumber),
    color: '#ffffff',
    fontSize: '12px',
    fontWeight: 'bold'
  } : null,
  icon: {
    path: google.maps.SymbolPath.CIRCLE,
    fillColor: site.utilisation <= 40 ? '#10b981' : '#ef4444',
    fillOpacity: 0.8,
    strokeColor: '#ffffff',
    strokeWeight: 2,
    scale: showMarkerLabels ? 8 : 5 // Larger when showing labels
  },
  optimized: true,
  zIndex: showMarkerLabels ? markerNumber : 0
});
```

## ğŸ“‹ ä½¿ç”¨ç¤ºä¾‹

### åœºæ™¯: æŸ¥æ‰¾ä¼¦æ•¦åœ°åŒºä½åˆ©ç”¨ç‡ç«™ç‚¹

1. **æ‰“å¼€ Power Analysis é¡µé¢**

2. **è®¾ç½®ç­›é€‰æ¡ä»¶:**
   - Region/Area: London
   - Max Utilisation: 30%
   - Min ONAN Rating: 2000 kVA
   - Density Radius: 10 km
   - Min Supplies: 5

3. **ç‚¹å‡» "ğŸ” Apply Filters to Map"**
   - â†’ åœ°å›¾æ˜¾ç¤ºç¬¦åˆæ¡ä»¶çš„ç«™ç‚¹
   - â†’ è‡ªåŠ¨ç¼©æ”¾åˆ°ä¼¦æ•¦åŒºåŸŸ
   - â†’ ä¸‹æ–¹åˆ—è¡¨æ˜¾ç¤ºæ‰€æœ‰ç«™ç‚¹

4. **å‹¾é€‰ "ğŸ·ï¸ Labels"**
   - â†’ åœ°å›¾æ ‡è®°æ˜¾ç¤ºç¼–å·
   - â†’ #1 æ˜¯åˆ©ç”¨ç‡æœ€ä½çš„ç«™ç‚¹

5. **åˆ‡æ¢æ’åºåˆ° "Supplies in Radius"**
   - â†’ åˆ—è¡¨é‡æ–°æ’åº
   - â†’ åœ°å›¾æ ‡è®°ç¼–å·è‡ªåŠ¨æ›´æ–°
   - â†’ #1 å˜æˆå‘¨è¾¹ç«™ç‚¹æ•°æœ€å¤šçš„ç«™ç‚¹

6. **æŸ¥çœ‹åˆ—è¡¨æ‰¾åˆ° #1 ç«™ç‚¹è¯¦æƒ…:**
   - ç«™ç‚¹åç§°
   - åœ°åŒº
   - åˆ©ç”¨ç‡
   - ONANå®¹é‡
   - å‘¨è¾¹ç«™ç‚¹æ•°

## ğŸ§ª æµ‹è¯•æ­¥éª¤

### æµ‹è¯• 1: åŸºæœ¬ç­›é€‰å’Œç¼©æ”¾
- [ ] æ‰“å¼€ Power Analysis
- [ ] åº”ç”¨ç­›é€‰
- [ ] éªŒè¯åœ°å›¾è‡ªåŠ¨ç¼©æ”¾
- [ ] éªŒè¯æ‰€æœ‰æ ‡è®°éƒ½åœ¨è§†é‡å†…

### æµ‹è¯• 2: Labels ç¼–å·åŠŸèƒ½
- [ ] å‹¾é€‰ "ğŸ·ï¸ Labels"
- [ ] éªŒè¯æ ‡è®°æ˜¾ç¤ºç¼–å·
- [ ] éªŒè¯æ ‡è®°å˜å¤§
- [ ] éªŒè¯ç¼–å·ä» 1 å¼€å§‹
- [ ] å–æ¶ˆå‹¾é€‰ï¼ŒéªŒè¯ç¼–å·æ¶ˆå¤±

### æµ‹è¯• 3: æ’åºåŒæ­¥
- [ ] é»˜è®¤æ’åº: Max Utilisation
- [ ] éªŒè¯ List #1 = åˆ©ç”¨ç‡æœ€ä½
- [ ] å¦‚æœ Labels å¼€å¯ï¼ŒéªŒè¯ Map #1 åŒæ­¥
- [ ] åˆ‡æ¢åˆ° ONAN Rating æ’åº
- [ ] éªŒè¯åˆ—è¡¨é‡æ–°æ’åº
- [ ] å¦‚æœ Labels å¼€å¯ï¼ŒéªŒè¯åœ°å›¾ç¼–å·æ›´æ–°
- [ ] åˆ‡æ¢åˆ° Supplies in Radius æ’åº
- [ ] éªŒè¯åˆ—è¡¨é‡æ–°æ’åºï¼ˆå¤§åˆ°å°ï¼‰
- [ ] å¦‚æœ Labels å¼€å¯ï¼ŒéªŒè¯åœ°å›¾ç¼–å·æ›´æ–°

### æµ‹è¯• 4: Region ç­›é€‰
- [ ] é€‰æ‹© Region: Cambridge
- [ ] åº”ç”¨ç­›é€‰
- [ ] éªŒè¯åœ°å›¾ç¼©æ”¾åˆ° Cambridge åŒºåŸŸ
- [ ] éªŒè¯åªæ˜¾ç¤º Cambridge çš„ç«™ç‚¹

### æµ‹è¯• 5: Search åŠŸèƒ½
- [ ] è¾“å…¥æœç´¢è¯ï¼ˆå¦‚ "London"ï¼‰
- [ ] åº”ç”¨ç­›é€‰
- [ ] éªŒè¯åªæ˜¾ç¤ºåŒ¹é…çš„ç«™ç‚¹
- [ ] éªŒè¯åœ°å›¾è‡ªåŠ¨ç¼©æ”¾

## ğŸ“Š ä»£ç å˜æ›´æ‘˜è¦

### app.js
**æ–°å¢:**
- `showMarkerLabels` å˜é‡
- `currentSortBy` å˜é‡
- `getSortedSites()` å‡½æ•° (~20 lines)

**ä¿®æ”¹:**
- `loadSitesOnMap()` - æ·»åŠ æ’åºå’Œç¼–å· (~15 lines)
- `createMarkersInBatches()` - æ·»åŠ labelå±æ€§ (~10 lines)
- `toggleLabels()` - å®ç°åˆ‡æ¢åŠŸèƒ½ (~8 lines)
- `sortFilteredSites()` - æ·»åŠ åŒæ­¥é€»è¾‘ (~15 lines)

**æ€»è®¡:** ~70 lines new/modified code

### æ–‡ä»¶åŒæ­¥
âœ… `frontend/app.js` â†’ `docs/app.js`

## ğŸ’¡ å…³é”®ç‰¹æ€§

### âœ… æ™ºèƒ½åœ°å›¾ç¼©æ”¾
- è‡ªåŠ¨åŒ…å«æ‰€æœ‰ç­›é€‰ç»“æœ
- æ— éœ€æ‰‹åŠ¨è°ƒæ•´è§†é‡
- é˜²æ­¢è¿‡åº¦æ”¾å¤§

### âœ… åŠ¨æ€æ ‡è®°ç¼–å·
- å¯é€‰æ˜¾ç¤º/éšè—
- åŸºäºå®æ—¶æ’åº
- ä¸åˆ—è¡¨å®Œç¾åŒæ­¥

### âœ… çµæ´»æ’åºç³»ç»Ÿ
- ä¸‰ç§æ’åºæ–¹å¼
- å®æ—¶æ›´æ–°ç¼–å·
- é«˜äº®æ’åºåˆ—

### âœ… å¤šç»´åº¦ç­›é€‰
- 6ä¸ªç­›é€‰æ¡ä»¶
- å®æ—¶æœç´¢
- åŒºåŸŸè¿‡æ»¤

## ğŸš€ éƒ¨ç½²è¯´æ˜

1. **å¼ºåˆ¶åˆ·æ–°æµè§ˆå™¨:** `Cmd + Shift + R` (Mac) æˆ– `Ctrl + Shift + R` (Windows)
2. **å¯¼èˆªåˆ° Power Analysis é¡µé¢**
3. **åº”ç”¨ç­›é€‰æµ‹è¯•è‡ªåŠ¨ç¼©æ”¾**
4. **å‹¾é€‰ Labels æŸ¥çœ‹ç¼–å·**
5. **åˆ‡æ¢æ’åºéªŒè¯ç¼–å·åŒæ­¥**

## ğŸ“š ç›¸å…³æ–‡æ¡£

- `POWER_ANALYSIS_UPGRADE.md` - Power Analysis åˆå§‹å‡çº§æ–‡æ¡£
- `HOW_TO_USE_v2.2.md` - Power Analysis ä½¿ç”¨æŒ‡å—
- `REGION_SEARCH_UPDATE.md` - Region/Search åŠŸèƒ½æ–‡æ¡£

## ğŸ”— ç‰ˆæœ¬ä¿¡æ¯

- **Version:** 2.5.4
- **Date:** 2026-01-04
- **Features:** Auto Zoom + Marker Numbering + Sort Sync
- **Status:** Production Ready âœ…

---

**å®Œæˆæ—¶é—´:** 2026-01-04
**å¼€å‘è€…:** AI Assistant + User
**çŠ¶æ€:** å·²æµ‹è¯•å¹¶å‡†å¤‡éƒ¨ç½²

